//
//  GearDetailViewController.swift
//  GearCollectionApp
//
//  Created by ÂùÇÊú¨„ÄÄÂ§ßË≤¥ on 2023/02/23.
//

import UIKit
import RealmSwift

class GearDetailViewController: UIViewController, UIPickerViewDelegate, UIPickerViewDataSource, UIImagePickerControllerDelegate, UINavigationControllerDelegate {

    @IBOutlet weak var categoryText: UITextField!
    @IBOutlet weak var makerText: UITextField!
    @IBOutlet weak var nameText: UITextField!
    @IBOutlet weak var amountText: UITextField!
    @IBOutlet weak var weightText: UITextField!
    @IBOutlet weak var dateText: UITextField!
    @IBOutlet weak var addButton: UIButton!
    @IBOutlet weak var imageView: UIImageView!
    
    var record = GearRecord()
    var geardataList: Results<GearRecord>!

    // ÁôªÈå≤„Éú„Çø„É≥
    @IBAction func addButton(_ sender: UIButton) {
        let storyboard = UIStoryboard(name: "Main", bundle: nil)
        let gearDetailViewConntroller = storyboard.instantiateViewController(identifier: "GearDetail") as! GearDetailViewController
        navigationController?.pushViewController(gearDetailViewConntroller, animated: true)
        saveRecord()
        saveImage()
    }
    // „Ç´„ÉÜ„Ç¥„É™„ÅåÊú™ÂÖ•Âäõ„ÅÆÂ†¥Âêà„ÄÅ„ÄåÁôªÈå≤„Åô„Çã„Äç„Éú„Çø„É≥„ÇíÁÑ°Âäπ„Å´„Åô„Çã
    @IBAction func categoryTextBtnInactive(_ sender: Any) {
        if categoryText.text == "" {
            addButton.isEnabled = false
        } else {
            addButton.isEnabled = true
        }
    }
    // „É°„Éº„Ç´„Éº„ÅåÊú™ÂÖ•Âäõ„ÅÆÂ†¥Âêà„ÄÅ„ÄåÁôªÈå≤„Åô„Çã„Äç„Éú„Çø„É≥„ÇíÁÑ°Âäπ„Å´„Åô„Çã
    @IBAction func makerTextBtnInactive(_ sender: Any) {
        if makerText.text == "" {
            addButton.isEnabled = false
        } else {
            addButton.isEnabled = true
        }
    }
    // ÂêçÂâç„ÅåÊú™ÂÖ•Âäõ„ÅÆÂ†¥Âêà„ÄÅ„ÄåÁôªÈå≤„Åô„Çã„Äç„Éú„Çø„É≥„ÇíÁÑ°Âäπ„Å´„Åô„Çã
    @IBAction func nameTextBtnInactive(_ sender: Any) {
        if nameText.text == "" {
            addButton.isEnabled = false
        } else {
            addButton.isEnabled = true
        }
    }
    
    let realm = try! Realm()
    
    // ÂÜôÁúü„ÇíËøΩÂä†„Åô„Çã„Éú„Çø„É≥
    @IBAction func photoButton(_ sender: UIButton) {
        let imagePickerController = UIImagePickerController()
        imagePickerController.sourceType = .photoLibrary
        imagePickerController.delegate = self
        present(imagePickerController, animated: true, completion: nil)
    }
    // ÂÜôÁúüÈÅ∏Êäû„ÅåÂÆå‰∫Ü„Åó„ÅüÊôÇ„Å´Âëº„Å≥Âá∫„Åï„Çå„Çã„É°„ÇΩ„ÉÉ„Éâ
    func imagePickerController(_ picker: UIImagePickerController, didFinishPickingMediaWithInfo info: [UIImagePickerController.InfoKey : Any]) {
        dismiss(animated: true, completion: nil)
        
        guard let selectedImage = info[.originalImage] as? UIImage else {
            fatalError("Ecpected a dictionary containing on image, but was provided the following: \(info)")
        }
        imageView.image = selectedImage
        saveImage()
        let record = GearRecord()
        do {
            try record.imageURL = documentDirectoryFileURL.absoluteString
        } catch {
            print("ÁîªÂÉè„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºÅ")
        }
        try! realm.write{realm.add(record)}
        
    }
    
    
    @objc func didTapDone() {
        view.endEditing(true)
    }
    
    var category: String = ""
    var maker: String = ""
    var name: String = ""
    var amount: Int = 0
    var weight: Double = 0.0
    var date: Date = Date()
    var image: String = ""
    
    var gearList: [GearRecord] = []

    override func viewDidLoad() {
        super.viewDidLoad()
        addButton.isEnabled = false
        displayData()
        createPickerView()
        configureDateTextField()
        gearList = Array(gearList)
        geardataList = realm.objects(GearRecord.self)
        closeKeyboard()
        print("üëÄfirstRecord: \(String(describing: gearList))")
    }
    
    
    func configure(gear: GearDataModel) {
        category = gear.category
        maker = gear.maker
        name = gear.name
        amount = gear.amount
        weight = gear.weight
        date = gear.date
    }
    
    func displayData() {
        categoryText.text = category
        makerText.text = maker
        nameText.text = name
        var toIntAmount: Int? = Int(amountText.text!)
        var toIntWeight: Double? = Double(weightText.text!)
        dateText.inputView = datePicker
        dateText.text = dateFormatter.string(from: Date()) // datePicker„ÅßÈÅ∏Êäû„Åï„Çå„ÅüÊó•‰ªò„ÇíStringÂûã„Å´Â§âÊèõ
    }
    
    // Êó•‰ªò„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÈöõ„Å´„ÄÅUITextField„Å´Êó•‰ªò„ÅåË°®Á§∫„Åï„Çå„Çã„Çà„ÅÜ„Å´„Åô„Çã„É°„ÇΩ„ÉÉ„Éâ
    @objc func didChangeDate(picker: UIDatePicker) {
        dateText.text = dateFormatter.string(from: picker.date)
    }
    
    // „Éá„Éº„Çø„ÇíRealm„Å´‰øùÂ≠ò„Åô„ÇãÂá¶ÁêÜ
    func saveRecord() {
        let realm = try! Realm()
        try! realm.write {
            if let categoryText = categoryText.text,
               let category = String?(categoryText) {
                record.category = category
            }
            if let makerText = makerText.text,
               let maker = String?(makerText) {
                record.maker = maker
            }
            if let nameText = nameText.text,
               let name = String?(nameText) {
                record.name = name
            }
            if let amountText = amountText.text,
               let amount = Int(amountText) {
                record.amount = amount
            }
            if let weightText = weightText.text,
               let weight = Double(weightText) {
                record.weight = weight
            }
            if let dateText = dateText.text,
               let date = dateFormatter.date(from: dateText) {
                record.date = date
            }
            realm.add(record)
        }
        dismiss(animated: true) // ÁîªÈù¢„ÇíÈñâ„Åò„ÇãÂá¶ÁêÜ
    }

    var pickerView = UIPickerView()
    var categoryData = ["TENT&TARP", "TABLE&CHAIR", "FIRE", "KITCHEN&TABLEWEAR", "SLEEPING", "OTHER"]
    
    
    var documentDirectoryFileURL = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask)[0]
    let filePath = NSSearchPathForDirectoriesInDomains(.documentDirectory, .userDomainMask, true)[0]    
    
    func createLocalDataFile() {
        let fileName = "(NSUUID().uuidString).png"
        if documentDirectoryFileURL != nil {
            let path = documentDirectoryFileURL.appendingPathComponent(fileName)
            documentDirectoryFileURL = path
        }
    }
    
    func saveImage() {
        createLocalDataFile()
        let pngImageData = imageView.image?.pngData()
        do {
            try pngImageData!.write(to: documentDirectoryFileURL)
        } catch {
            print("„Ç®„É©„ÉºÔºÅ")
        }
    }
    
}


















// MARK: DatePickerÈñ¢ÈÄ£
extension GearDetailViewController {
    // Êó•‰ªòÂÖ•Âäõ„ÅÆTextField„Å´„ÄÅDatePicker„ÇíÂÆüË£ÖÔºàË®≠ÂÆöÔºâ
    var datePicker: UIDatePicker {
        let datePicker: UIDatePicker = UIDatePicker()
        datePicker.datePickerMode = .date
        datePicker.timeZone = .current // „Çø„Ç§„É†„Çæ„Éº„É≥„ÇíÁèæÂú®‰ΩçÁΩÆ„Å´Ë®≠ÂÆö
        datePicker.preferredDatePickerStyle = .wheels // „Éõ„Ç§„Éº„É´„Çπ„Çø„Ç§„É´„ÅÆUI„ÇíÊåáÂÆö
        datePicker.locale = Locale(identifier: "ja_JP") // Êó•Êú¨„ÅÆ„É≠„Ç±„Éº„É´„ÇíÊåáÂÆö
        datePicker.date = Date() // ÁèæÂú®„ÅÆÊó•‰ªò„Çí‰ª£ÂÖ•
        datePicker.addTarget(self, action: #selector(didChangeDate), for: .valueChanged) // „Éî„ÉÉ„Ç´„Éº„ÅÆÂÄ§„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÈöõ„Å´„ÄÅdidChangeDate„É°„ÇΩ„ÉÉ„Éâ„ÇíÂÆüË°å
        return datePicker
    }
    
    // Êó•‰ªò„ÇíUITextField„Å´Ë°®Á§∫„Åô„ÇãÔºàÊó•‰ªò„ÅÆÂÄ§„ÇíÊñáÂ≠óÂàó„Å´Â§âÊèõÔºâ
    var dateFormatter: DateFormatter {
        let dateFormatt = DateFormatter()
        dateFormatt.dateStyle = .long
        dateFormatt.timeZone = .current
        dateFormatt.locale = Locale(identifier: "ja_JP")
        return dateFormatt
    }
    // „Ç´„ÉÜ„Ç¥„É™ÂÖ•ÂäõÊôÇ„Å´„ÄÅPickerView„ÅÆË®≠ÂÆö
    func numberOfComponents(in pickerView: UIPickerView) -> Int {
        return 1
    }
    
    func pickerView(_ pickerView: UIPickerView, numberOfRowsInComponent component: Int) -> Int {
        return categoryData.count
    }
    
    func pickerView(_ pickerView: UIPickerView, titleForRow row: Int, forComponent component: Int) -> String? {
        return categoryData[row]
    }
    
    func pickerView(_ pickerView: UIPickerView, didSelectRow row: Int, inComponent component: Int) {
        categoryText.text = categoryData[row]
    }
    
    @objc func donePicker() {
        categoryText.endEditing(true)
    }
    func createPickerView() {
        pickerView.delegate = self
        categoryText.inputView = pickerView
        let toolBar = UIToolbar()
        toolBar.frame = CGRect(x: 0, y: 0, width: self.view.frame.width, height: 44)
        let doneButtonItem = UIBarButtonItem(barButtonSystemItem: .done, target: self, action: #selector(GearDetailViewController.donePicker))
        toolBar.setItems([doneButtonItem], animated: true)
    
        }
    
    func configureDateTextField() {
        dateText.inputView = datePicker
        dateText.text = dateFormatter.string(from: Date())
    }
}

// MARK: „Ç≠„Éº„Éú„Éº„ÉâÈñ¢ÈÄ£
extension GearDetailViewController {
    
    @objc func dismissKeyboard() {
        self.view.endEditing(true)
    }
    
    // ‰ªñ„ÅÆÂ†¥ÊâÄ„Çí„Çø„ÉÉ„Éó„Åó„Åü„Çâ„Ç≠„Éº„Éú„Éº„Éâ„ÅåÈñâ„Åò„ÇãË®≠ÂÆö
    @objc func closeKeyboard() {
        let tapGR: UITapGestureRecognizer = UITapGestureRecognizer(target: self, action: #selector(dismissKeyboard))
        tapGR.cancelsTouchesInView = false
        self.view.addGestureRecognizer(tapGR)
        NotificationCenter.default.addObserver(self, selector: #selector(namekeyboardWillShow), name: UIResponder.keyboardWillShowNotification, object: nil)
        NotificationCenter.default.addObserver(self, selector: #selector(amountkeyboardWillShow), name: UIResponder.keyboardWillShowNotification, object: nil)
        NotificationCenter.default.addObserver(self, selector: #selector(weightkeyboardWillShow), name: UIResponder.keyboardWillShowNotification, object: nil)
        NotificationCenter.default.addObserver(self, selector: #selector(datekeyboardWillShow), name: UIResponder.keyboardWillShowNotification, object: nil)
        NotificationCenter.default.addObserver(self, selector: #selector(keyboardWillHide), name: UIResponder.keyboardWillHideNotification, object: nil)
    }
    // „ÇÆ„Ç¢ÂêçÂÖ•ÂäõÊôÇ„ÄÅTextField„Å´„Ç≠„Éº„Éú„Éº„Éâ„ÅåË¢´„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
    @objc func namekeyboardWillShow(notification: NSNotification) {
        if !nameText.isFirstResponder {
            return
        }
        
        if self.view.frame.origin.y == 0 {
            if let keyboardRect = (notification.userInfo?[UIResponder.keyboardFrameEndUserInfoKey] as? NSValue)?.cgRectValue {
                self.view.frame.origin.y -= keyboardRect.height
            }
        }
    }
    // ÈáëÈ°çÂÖ•ÂäõÊôÇ„ÄÅTextField„Å´„Ç≠„Éº„Éú„Éº„Éâ„ÅåË¢´„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
    @objc func amountkeyboardWillShow(notification: NSNotification) {
        if !amountText.isFirstResponder {
            return
        }
        
        if self.view.frame.origin.y == 0 {
            if let keyboardRect = (notification.userInfo?[UIResponder.keyboardFrameEndUserInfoKey] as? NSValue)?.cgRectValue {
                self.view.frame.origin.y -= keyboardRect.height
            }
        }
    }
    // ÈáçÈáèÂÖ•ÂäõÊôÇ„ÄÅTextField„Å´„Ç≠„Éº„Éú„Éº„Éâ„ÅåË¢´„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
    @objc func weightkeyboardWillShow(notification: NSNotification) {
        if !weightText.isFirstResponder {
            return
        }
        
        if self.view.frame.origin.y == 0 {
            if let keyboardRect = (notification.userInfo?[UIResponder.keyboardFrameEndUserInfoKey] as? NSValue)?.cgRectValue {
                self.view.frame.origin.y -= keyboardRect.height
            }
        }
    }
    // Êó•‰ªòÂÖ•ÂäõÊôÇ„ÄÅTextField„Å´„Ç≠„Éº„Éú„Éº„Éâ„ÅåË¢´„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
    @objc func datekeyboardWillShow(notification: NSNotification) {
        if !dateText.isFirstResponder {
            return
        }
        
        if self.view.frame.origin.y == 0 {
            if let keyboardRect = (notification.userInfo?[UIResponder.keyboardFrameEndUserInfoKey] as? NSValue)?.cgRectValue {
                self.view.frame.origin.y -= keyboardRect.height
            }
        }
    }
    
    @objc func keyboardWillHide(notification: NSNotification) {
        if self.view.frame.origin.y != 0 {
            self.view.frame.origin.y = 0
        }
    }
}
